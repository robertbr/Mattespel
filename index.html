<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mattespel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .card-container {
            max-width: 480px; margin: 40px auto; padding: 30px 40px;
            background-color: white; border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #f0f0f0;
            min-height: 600px;
            display: flex; flex-direction: column; justify-content: center;
            position: relative; overflow: hidden;
        }
        .operator-btn {
            width: 50px; height: 50px; border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.25rem; font-weight: 300; transition: all 0.2s; cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); border: none;
            color: #4b5563; background-color: #f3f4f6;
        }
        .operator-btn.selected {
            background-color: #ff69b4; color: white;
            box-shadow: 0 6px 10px -3px rgba(255,105,180,0.5);
        }
        .operator-btn:hover:not(.selected) { background-color: #e5e7eb; }
        
        .range-input, .question-input { 
            text-align: center; border-radius: 6px; border: 1px solid #d1d5db; 
            outline: none; transition: 0.2s; width: 70px; padding: 6px 2px;
        }
        
        .game-input {
            padding: 0.5rem; font-size: 2.25rem; height: 5rem; border-width: 2px;
            text-align: center; border-radius: 8px; border-color: #d1d5db; outline: none;
        }
        .game-input:focus { border-color: #ff69b4; }
        
        .input-disabled { background-color: #f3f4f6; cursor: not-allowed; border-color: #e5e7eb; }
        .input-error { border-color: #ef4444; background-color: #fef2f2; }
        
        input[type=number] { -moz-appearance: textfield; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        #time-bar-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 8px; background: #f3f4f6; z-index: 10;
        }
        #time-bar {
            height: 100%; background: linear-gradient(90deg, #ff69b4, #be185d); width: 100%; transition: width 1s linear;
        }
        .score-table th { text-align: left; padding: 8px; font-size: 0.85rem; color: #6b7280; }
        .score-table td { padding: 8px; font-size: 0.95rem; border-bottom: 1px solid #f3f4f6; }
        .tab-btn.active { border-bottom: 2px solid #ff69b4; color: #be185d; font-weight: bold; }
        
        .score-row { cursor: pointer; transition: background-color 0.2s; }
        .score-row:hover { background-color: #fee2e2; }
        
        .table-btn {
            width: 36px; height: 36px; border-radius: 8px; font-weight: 600; font-size: 0.9rem;
            background-color: #f3f4f6; color: #4b5563; transition: all 0.2s;
        }
        .table-btn.selected {
            background-color: #3b82f6; color: white;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.5);
        }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .toggle-checkbox:checked { right: 0; border-color: #68D391; }
        .toggle-checkbox:checked + .toggle-label { background-color: #68D391; }
        
        .menu-circle-btn {
            width: 36px; height: 36px; border-radius: 9999px; 
            display: flex; align-items: center; justify-content: center;
            background-color: #f3f4f6; color: #4b5563; transition: all 0.2s;
        }
        .menu-circle-btn:hover { background-color: #e5e7eb; transform: scale(1.05); }
        /* Numpad Styles */
        .numpad-btn {
            background-color: #f9fafb; border: 1px solid #e5e7eb; border-radius: 8px;
            font-size: 1.25rem; font-weight: 600; color: #374151; padding: 10px;
            transition: background-color 0.1s;
        }
        .numpad-btn:active { background-color: #d1d5db; }
        /* Special alignment for operators */
        .op-col { text-align: center; width: 60px; }
        .val-col-r { text-align: right; }
        .val-col-l { text-align: left; }

        /* Superscript styling for power */
        .sup-exp {
            vertical-align: super;
            font-size: 0.6em;
            margin-left: 2px;
        }
        .sup-exp-btn {
            position: relative;
            top: -0.2em;
            font-size: 0.6em;
            margin-left: 2px;
        }

        /* Tips Button & Container */
        #tips-btn-wrapper {
            position: absolute;
            left: 100%;
            top: 0;
            bottom: 0;
            margin-left: 8px; /* Tighter margin */
            display: flex;
            align-items: center;
        }
        #answer-helper-btn {
            background-color: #3b82f6; /* Blue */
            color: white;
            border: none;
            padding: 0;
            width: 80px;
            height: 5rem; /* Match input height */
            border-radius: 8px; 
            font-size: 1.1rem; 
            font-weight: bold;
            cursor: pointer; 
            transition: all 0.1s;
            opacity: 0; pointer-events: none;
            box-shadow: 0 4px 0 #1d4ed8; /* Darker blue shadow */
            display: flex; align-items: center; justify-content: center;
        }
        #answer-helper-btn.visible { opacity: 1; pointer-events: auto; }
        #answer-helper-btn:active { 
            box-shadow: 0 0 0 #1d4ed8; 
            transform: translateY(4px); 
        }

        /* Tips Grid */
        #tips-container {
            width: 100%; max-width: 320px; margin: 0 auto;
        }
        .tips-option {
            background-color: white; border: 2px solid #e5e7eb;
            border-radius: 12px; padding: 20px; font-size: 1.5rem;
            font-weight: bold; color: #374151; cursor: pointer;
            transition: all 0.1s; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
            display: flex; align-items: center; justify-content: center;
        }
        .tips-option:hover { background-color: #f9fafb; border-color: #d1d5db; }
        .tips-option:active { transform: scale(0.98); }
        .tips-option.wrong { background-color: #fee2e2; border-color: #ef4444; color: #b91c1c; }
        .tips-option.correct { background-color: #dcfce7; border-color: #22c55e; color: #15803d; }

        /* Percent Selection */
        .pct-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-bottom: 8px; }
        .pct-btn {
            font-size: 0.75rem; padding: 6px 2px; border-radius: 6px; border: 1px solid #e5e7eb;
            background: #fff; cursor: pointer; transition: 0.2s; font-weight: 500;
        }
        .pct-btn.selected { background: #3b82f6; color: white; border-color: #2563eb; }
        .select-all-btn {
            font-size: 0.75rem; font-weight: bold; color: #4b5563; cursor: pointer;
            background-color: #e5e7eb; padding: 4px 12px; border-radius: 6px;
            transition: 0.2s; border: 1px solid #d1d5db;
        }
        .select-all-btn:hover { background-color: #d1d5db; }

        /* Settings Toggle Group (Square style) */
        .toggle-group {
            display: inline-flex;
            background-color: #e5e7eb;
            padding: 4px;
            border-radius: 8px;
        }
        .toggle-btn-opt {
            padding: 8px 16px;
            font-size: 0.875rem;
            font-weight: 700;
            color: #4b5563;
            border-radius: 6px;
            transition: all 0.2s;
            background: transparent;
        }
        .toggle-btn-opt:hover { background-color: rgba(255,255,255,0.5); }
        .toggle-btn-opt.active {
            background-color: white;
            color: #1f2937;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-50 p-4 font-sans">
    <div class="card-container">
        
        <!-- TOP RIGHT MENU -->
        <div id="top-menu" class="absolute top-4 right-4 flex gap-2 z-20">
            <button onclick="showStatsView()" class="menu-circle-btn" title="Statistik">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>
            </button>
            <button onclick="showInfoModal()" class="menu-circle-btn" title="Information"><span class="font-bold text-lg font-serif italic">i</span></button>
            <button onclick="showSettings()" class="menu-circle-btn" title="Inst√§llningar">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            </button>
            <button onclick="showSaveLoadModal()" class="menu-circle-btn" title="Spara/Ladda">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" /></svg>
            </button>
        </div>

        <!-- 0. START MENU -->
        <div id="start-menu-view" class="text-center view-section relative h-full pt-8">
            <h1 class="text-3xl font-bold mb-8 text-gray-800">Mattespel</h1>
            
            <div class="space-y-4 flex flex-col items-center">
                <button onclick="showView('table-training-settings-view')" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-4 px-12 rounded-xl transition duration-200 w-full max-w-xs text-lg shadow-lg relative overflow-hidden group">
                    <span class="relative z-10">Tabelltr√§ning üî¢</span>
                    <span class="block text-xs font-normal text-blue-200 mt-1 relative z-10">√ñva specifika tabeller p√• tid</span>
                    <div class="absolute inset-0 bg-blue-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left duration-300"></div>
                </button>
                
                <button onclick="showView('settings-view')" class="bg-gray-800 hover:bg-gray-900 text-white font-medium py-4 px-12 rounded-xl transition duration-200 w-full max-w-xs text-lg shadow-lg">
                    √ñva üéì
                    <span class="block text-xs font-normal text-gray-300 mt-1">V√§lj inst√§llningar sj√§lv</span>
                </button>
                
                <button onclick="showView('compete-settings-view')" class="bg-pink-500 hover:bg-pink-600 text-white font-medium py-4 px-12 rounded-xl transition duration-200 w-full max-w-xs text-lg shadow-lg">
                    T√§vla üèÜ
                    <span class="block text-xs font-normal text-pink-100 mt-1">Spara rekord (1-10:an)</span>
                </button>

                <button onclick="showToplists()" class="text-gray-500 hover:text-gray-800 font-medium py-2 px-6 mt-2 transition">
                    Visa Topplistor üèÖ
                </button>
            </div>
        </div>

        <!-- 0.5 TABLE TRAINING SETTINGS -->
        <div id="table-training-settings-view" class="hidden text-center view-section pt-8">
            <h1 class="text-xl font-bold mb-4">Tabelltr√§ning</h1>
            
            <p class="text-sm text-gray-600 mb-2">V√§lj tabeller att √∂va p√•:</p>
            <div id="training-tables-selection" class="flex flex-wrap justify-center gap-2 mb-8 px-4">
                <!-- Buttons 0-10 genereras via JS -->
            </div>

            <h3 class="text-lg font-bold mb-4">V√§lj tid ‚è±Ô∏è</h3>
            <div class="grid grid-cols-2 gap-4 mb-8 max-w-xs mx-auto">
                <button onclick="startTableTraining(3)" class="bg-gradient-to-r from-teal-400 to-blue-500 text-white font-bold py-4 rounded-xl shadow-md transform hover:scale-105 transition">
                    3 min
                </button>
                <button onclick="startTableTraining(5)" class="bg-gradient-to-r from-teal-400 to-blue-500 text-white font-bold py-4 rounded-xl shadow-md transform hover:scale-105 transition">
                    5 min
                </button>
                <button onclick="startTableTraining(7)" class="bg-gradient-to-r from-teal-400 to-blue-500 text-white font-bold py-4 rounded-xl shadow-md transform hover:scale-105 transition">
                    7 min
                </button>
                <button onclick="startTableTraining(10)" class="bg-gradient-to-r from-teal-400 to-blue-500 text-white font-bold py-4 rounded-xl shadow-md transform hover:scale-105 transition">
                    10 min
                </button>
            </div>
            
            <button onclick="showView('start-menu-view')" class="text-gray-400 hover:text-gray-600 text-sm underline">G√• tillbaka</button>
        </div>

        <!-- 1A. PRACTICE SETTINGS -->
        <div id="settings-view" class="hidden view-section pt-8">
            <h1 class="text-xl font-semibold mb-6 text-center">√ñvningsinst√§llningar</h1>
            
            <div class="flex justify-center mb-6">
                <div class="bg-gray-200 p-1 rounded-lg inline-flex">
                    <button id="practice-mode-count" onclick="togglePracticeMode('count')" class="px-4 py-2 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition">Antal</button>
                    <button id="practice-mode-time" onclick="togglePracticeMode('time')" class="px-4 py-2 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition">Tid</button>
                </div>
            </div>

            <div class="mb-4 flex justify-center">
                <div id="operator-container" class="flex justify-center items-center gap-2 flex-wrap">
                    <button class="operator-btn" data-op="plus">+</button>
                    <button class="operator-btn" data-op="minus">-</button>
                    <button class="operator-btn selected" data-op="multiply">√ó</button>
                    <button class="operator-btn" data-op="divide">√∑</button>
                    <button class="operator-btn text-base font-normal" data-op="power">X<span class="sup-exp-btn">2</span></button>
                    <button class="operator-btn" data-op="modulo">%</button>
                </div>
            </div>

            <div id="table-practice-wrapper" class="hidden mb-6">
                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 text-center">
                    <label class="inline-flex items-center cursor-pointer mb-3">
                        <input type="checkbox" id="use-specific-tables" class="form-checkbox h-5 w-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500" onchange="toggleTableMode()">
                        <span class="ml-2 text-gray-700 font-medium">√ñva p√• en viss tabell</span>
                    </label>
                    <div id="specific-tables-selection" class="hidden flex flex-wrap justify-center gap-2"></div>
                </div>
            </div>

            <div id="interval-container" class="flex justify-between space-x-2 mb-6 transition-opacity duration-300 text-sm">
                <div class="flex-1 text-center">
                    <h3 class="font-bold mb-1">V√§nster tal</h3>
                    <div class="flex justify-center items-center space-x-1"><input type="number" id="left-min" min="0" max="9999" maxlength="4" value="1" class="range-input"><span class="text-gray-500">-</span><input type="number" id="left-max" min="0" max="9999" maxlength="4" value="10" class="range-input"></div>
                </div>
                <div class="flex-1 text-center">
                    <h3 class="font-bold mb-1">H√∂ger tal</h3>
                    <div class="flex justify-center items-center space-x-1"><input type="number" id="right-min" min="0" max="9999" maxlength="4" value="1" class="range-input"><span class="text-gray-500">-</span><input type="number" id="right-max" min="0" max="9999" maxlength="4" value="10" class="range-input"></div>
                </div>
            </div>

            <div id="sq-interval-container" class="hidden mb-6 text-center transition-opacity duration-300">
                <h3 class="text-sm font-bold mb-1">Intervall f√∂r kvadraten</h3>
                <div class="flex justify-center items-center space-x-2"><input type="number" id="sq-min" min="0" max="999" maxlength="3" value="1" class="range-input"><span class="text-gray-500">till</span><input type="number" id="sq-max" min="0" max="999" maxlength="3" value="12" class="range-input"></div>
            </div>

            <div id="pct-interval-container" class="hidden mb-6 transition-opacity duration-300 text-sm text-center">
                <div class="flex justify-between items-end mb-2 px-2">
                    <h3 class="font-bold text-gray-700">V√§lj procenttal</h3>
                    <button class="select-all-btn" onclick="toggleAll('pct')">V√§lj alla</button>
                </div>
                <div class="pct-grid" id="pct-selection-grid"></div>
                
                <div class="flex justify-between items-end mb-2 mt-4 px-2">
                    <h3 class="font-bold text-gray-700">V√§lj tal</h3>
                    <button class="select-all-btn" onclick="toggleAll('num')">V√§lj alla</button>
                </div>
                <div class="pct-grid" id="pct-num-selection-grid"></div>
            </div>

            <div id="practice-count-input" class="mb-6 flex flex-col items-center">
                <h3 class="text-sm font-bold mb-2">Antal fr√•gor</h3>
                <input type="number" id="q-count" min="0" max="999" maxlength="3" value="10" class="question-input">
            </div>
            
            <!-- NEW PRACTICE TIME SELECTOR -->
            <div id="practice-time-input" class="mb-6 hidden">
                <h3 class="text-sm font-bold mb-2 text-center">V√§lj tid (minuter)</h3>
                <select id="practice-time-select" class="block w-full max-w-[200px] mx-auto p-3 text-lg border-2 border-gray-300 rounded-lg text-center font-bold text-gray-700 focus:border-blue-500 outline-none bg-white">
                    <!-- Options 1-15 generated via JS -->
                </select>
            </div>

            <div class="flex justify-center space-x-3">
                <button onclick="showView('start-menu-view')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-6 rounded-lg">Tillbaka</button>
                <button id="play-btn" class="bg-gray-800 hover:bg-gray-900 text-white font-medium py-3 px-12 rounded-lg transition duration-200">Starta</button>
            </div>
        </div>

        <!-- 1B. COMPETE SETTINGS -->
        <div id="compete-settings-view" class="hidden text-center view-section pt-8">
            <h1 class="text-2xl font-semibold mb-2">T√§vlingsl√§ge üèÜ</h1>
            <p class="text-gray-500 mb-8 text-sm">Multiplikationstabell 1-10</p>
            
            <h3 class="text-lg font-bold mb-4">V√§lj utmaning</h3>
            <div class="grid grid-cols-2 gap-4 mb-8 max-w-xs mx-auto">
                <button onclick="startCompetition(10)" class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold py-4 rounded-xl shadow-md transform hover:scale-105 transition">10 st <span class="block text-xs font-normal opacity-90 mt-1">Sprint</span></button>
                <button onclick="startCompetition(20)" class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold py-4 rounded-xl shadow-md transform hover:scale-105 transition">20 st <span class="block text-xs font-normal opacity-90 mt-1">Medel</span></button>
                <button onclick="startCompetition(42)" class="bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold py-4 rounded-xl shadow-md transform hover:scale-105 transition">42 st <span class="block text-xs font-normal opacity-90 mt-1">Maraton</span></button>
                <button onclick="startCompetition('time')" class="bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold py-4 rounded-xl shadow-md transform hover:scale-105 transition">Tidspress ‚è±Ô∏è <span class="block text-xs font-normal opacity-90 mt-1">Max antal p√• 1 min</span></button>
            </div>
            
            <button onclick="showView('start-menu-view')" class="text-gray-400 hover:text-gray-600 text-sm underline">G√• tillbaka</button>
        </div>

        <!-- 2. GAME VIEW -->
        <div id="game-view" class="hidden text-center p-8 relative view-section">
            <div id="time-bar-container" class="hidden"><div id="time-bar"></div></div>
            <div id="table-info-text" class="hidden absolute top-4 right-4 text-[10px] text-gray-400 text-right max-w-[200px]"></div>

            <p class="text-lg text-gray-500 mb-6 mt-2" id="q-counter">1 av 10</p>
            
            <!-- QUESTION GRID -->
            <div id="equation-grid" class="grid grid-cols-[1fr_auto_1fr_auto] gap-x-4 items-baseline justify-center max-w-lg mx-auto mb-6">
                <!-- Row 1: Current -->
                <div id="op1" class="val-col-r text-5xl md:text-6xl font-extrabold text-gray-900"></div>
                <div id="op-sym" class="op-col text-5xl md:text-6xl font-extrabold text-gray-900"></div>
                <div id="op2" class="val-col-l text-5xl md:text-6xl font-extrabold text-gray-900"></div>
                <div class="text-left text-5xl md:text-6xl font-extrabold text-gray-900">=</div>

                <!-- Row 2: Next (Preview) -->
                <div id="next-op1" class="val-col-r text-4xl font-bold text-gray-400 transition-opacity next-q-el"></div>
                <div id="next-sym" class="op-col text-4xl font-bold text-gray-400 transition-opacity next-q-el"></div>
                <div id="next-op2" class="val-col-l text-4xl font-bold text-gray-400 transition-opacity next-q-el"></div>
                <div></div> <!-- Empty placeholder -->
                
                <!-- Row 3: Following (Preview Level 2) -->
                <div id="fol-op1" class="val-col-r text-4xl font-bold text-gray-400 transition-opacity fol-q-el hidden"></div>
                <div id="fol-sym" class="op-col text-4xl font-bold text-gray-400 transition-opacity fol-q-el hidden"></div>
                <div id="fol-op2" class="val-col-l text-4xl font-bold text-gray-400 transition-opacity fol-q-el hidden"></div>
                <div class="fol-q-el hidden"></div>

                <!-- Row 4: Following 2 (Preview Level 3) -->
                <div id="fol2-op1" class="val-col-r text-4xl font-bold text-gray-400 transition-opacity fol2-q-el hidden"></div>
                <div id="fol2-sym" class="op-col text-4xl font-bold text-gray-400 transition-opacity fol2-q-el hidden"></div>
                <div id="fol2-op2" class="val-col-l text-4xl font-bold text-gray-400 transition-opacity fol2-q-el hidden"></div>
                <div class="fol2-q-el hidden"></div>
            </div>

            <p id="hint-text" class="text-sm text-gray-500 h-6 mb-6"></p>

            <div id="input-area" class="relative flex justify-center items-center gap-3 min-h-[5rem]"></div>
            
            <div id="numpad-container" class="hidden grid grid-cols-3 gap-2 max-w-xs mx-auto mt-4">
                <button class="numpad-btn" onclick="numpadPress(1)">1</button><button class="numpad-btn" onclick="numpadPress(2)">2</button><button class="numpad-btn" onclick="numpadPress(3)">3</button>
                <button class="numpad-btn" onclick="numpadPress(4)">4</button><button class="numpad-btn" onclick="numpadPress(5)">5</button><button class="numpad-btn" onclick="numpadPress(6)">6</button>
                <button class="numpad-btn" onclick="numpadPress(7)">7</button><button class="numpad-btn" onclick="numpadPress(8)">8</button><button class="numpad-btn" onclick="numpadPress(9)">9</button>
                <button class="numpad-btn bg-red-50 text-red-600 border-red-200" onclick="numpadBackspace()">‚å´</button><button class="numpad-btn" onclick="numpadPress(0)">0</button>
                <button class="numpad-btn bg-blue-50 text-blue-600 border-blue-200" onclick="numpadPress(',')">,</button>
            </div>
            
            <!-- TIPS GRID CONTAINER (Hidden by default) -->
            <div id="tips-container" class="hidden grid grid-cols-2 gap-3 mt-4">
                <!-- JS will populate -->
            </div>
        </div>

        <!-- Countdown Overlay -->
        <div id="countdown-layer" class="hidden absolute inset-0 bg-gray-50 z-50 flex items-center justify-center">
            <div id="countdown-number" class="text-9xl font-bold text-pink-600 animate-bounce">3</div>
        </div>

        <!-- 3. RESULTS VIEW -->
        <div id="results-view" class="hidden text-center p-8 view-section">
            <h2 class="text-4xl font-bold mb-4 text-gray-900">Bra jobbat! üéâ</h2>
            <p id="result-message" class="text-xl mb-2 text-gray-700"></p>
            <p id="result-subtext" class="text-sm text-gray-500 mb-8"></p>
            
            <div class="space-y-3 flex flex-col items-center w-full">
                <button id="again-btn" class="bg-gray-800 hover:bg-gray-900 text-white font-medium py-3 px-4 rounded-lg w-full max-w-xs transition">Spela igen ‚ü≥</button>
                <button id="toplists-btn" onclick="showToplists()" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-800 border border-yellow-200 font-medium py-3 px-4 rounded-lg w-full max-w-xs transition">Topplistor üèÖ</button>
                <div class="flex space-x-2 w-full max-w-sm">
                    <button onclick="showView('table-training-settings-view')" class="flex-1 bg-blue-50 hover:bg-blue-100 text-blue-700 font-medium py-3 rounded-lg transition border border-blue-200 text-sm">Tr√§na</button>
                    <button onclick="showView('settings-view')" class="flex-1 bg-green-100 hover:bg-green-200 text-green-700 font-medium py-3 rounded-lg transition border border-green-200 text-sm">√ñva</button>
                    <button onclick="showView('compete-settings-view')" class="flex-1 bg-pink-50 hover:bg-pink-100 text-pink-700 font-medium py-3 rounded-lg transition border border-pink-200 text-sm">T√§vla</button>
                </div>
            </div>
        </div>

        <!-- 3.5 TABLE TRAINING RESULTS VIEW -->
        <div id="table-training-results-view" class="hidden text-center p-6 view-section">
            <h2 class="text-3xl font-bold mb-2 text-gray-800">Tr√§ning klar! ‚úÖ</h2>
            
            <div class="flex justify-center space-x-8 mb-6 text-gray-600">
                <div><div class="text-3xl font-bold text-gray-900" id="tt-total-count">0</div><div class="text-xs uppercase tracking-wide">Uppgifter</div></div>
                <div><div class="text-3xl font-bold text-blue-600 flex items-center gap-1 justify-center"><span id="tt-avg-speed">0,00</span><span class="inline-flex justify-center items-center w-4 h-4 rounded-full bg-gray-200 text-gray-500 text-[10px] cursor-help mb-2" title="Sekunder per uppgift">i</span></div><div class="text-xs uppercase tracking-wide">s/u</div></div>
            </div>

            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div class="bg-green-50 p-3 rounded-lg border border-green-100"><span class="block text-green-800 font-bold mb-1">B√§sta tabell üåü</span><span id="tt-best-table" class="text-lg text-green-600 font-bold">-</span></div>
                <div class="bg-red-50 p-3 rounded-lg border border-red-100"><span class="block text-red-800 font-bold mb-1">Sv√•raste tabell üê¢</span><span id="tt-worst-table" class="text-lg text-red-600 font-bold">-</span></div>
            </div>

            <h3 class="font-bold text-gray-700 mb-2 text-left w-full max-w-md mx-auto pl-2">Alla uppgifter (Snabbast f√∂rst)</h3>
            <div class="bg-white border border-gray-200 rounded-lg shadow-inner max-h-[200px] overflow-y-auto w-full max-w-md mx-auto mb-6 custom-scroll">
                <table class="w-full text-sm text-left score-table"><tbody id="tt-detail-list"></tbody></table>
            </div>
            
            <div class="space-y-3 flex flex-col items-center w-full">
                <button id="tt-practice-hardest-btn" class="bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg w-full max-w-xs transition shadow-md flex flex-col items-center"><span>√ñva p√• de sv√•raste üî•</span><span class="text-[10px] font-normal opacity-90 mt-1">Du √∂var p√• den sv√•raste fj√§rdedelen av uppgifterna.</span></button>
                <button id="tt-practice-worst-table-btn" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg w-full max-w-xs transition shadow-md hidden">√ñva X:ans tabell</button>
                
                <div class="flex space-x-3 w-full max-w-xs">
                    <button onclick="startLastTableTraining()" class="flex-1 bg-gray-800 hover:bg-gray-900 text-white font-medium py-3 rounded-lg transition">Tr√§na igen</button>
                    <button onclick="showView('start-menu-view')" class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 rounded-lg transition">Meny</button>
                </div>
            </div>
        </div>

        <!-- 4. RECORD INPUT VIEW -->
        <div id="record-view" class="hidden text-center p-8 view-section">
            <h2 class="text-3xl font-bold mb-2 text-pink-600">Nytt Rekord! üèÜ</h2>
            <p class="text-gray-600 mb-6">Du tog dig in p√• topplistan!</p>
            <p id="record-details" class="font-bold text-xl mb-6 text-gray-800"></p>
            
            <input type="text" id="player-name" placeholder="Ditt namn" maxlength="15" class="w-full max-w-xs p-3 border-2 border-gray-300 rounded-lg text-center text-xl mb-6 uppercase" autofocus>
            <button id="save-record-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-lg w-full max-w-xs shadow-md">Spara</button>
        </div>

        <!-- 5. TOPLIST VIEW -->
        <div id="toplist-view" class="hidden p-6 view-section">
            <h2 class="text-2xl font-bold mb-6 text-center">Topplistor üèÜ</h2>
            <div class="flex justify-center border-b border-gray-200 mb-4">
                <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" onclick="renderToplist('10')">10 st</button>
                <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" onclick="renderToplist('20')">20 st</button>
                <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" onclick="renderToplist('42')">42 st</button>
                <button class="tab-btn px-4 py-2 text-gray-500 hover:text-gray-700" onclick="renderToplist('time')">Tid</button>
            </div>
            <div id="toplist-content" class="mb-8 min-h-[200px]"></div>
            
            <div class="flex flex-col items-center space-y-3">
                 <button id="toplist-again-btn" class="bg-gray-800 hover:bg-gray-900 text-white font-medium py-3 px-4 rounded-lg w-full max-w-xs transition">Spela igen ‚ü≥</button>
                 <div class="flex space-x-3 w-full max-w-xs">
                    <button onclick="showView('compete-settings-view')" class="flex-1 bg-pink-50 hover:bg-pink-100 text-pink-700 font-medium py-3 rounded-lg transition border border-pink-200">T√§vla</button>
                    <button onclick="showView('start-menu-view')" class="flex-1 bg-gray-100 hover:bg-gray-200 text-gray-700 font-medium py-3 rounded-lg transition border border-gray-200">Meny</button>
                </div>
            </div>
        </div>

        <!-- 6. SETTINGS MODAL -->
        <div id="settings-modal" class="hidden absolute inset-0 bg-gray-500 bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-xl p-6 w-80 max-w-full mx-4">
                <h2 class="text-xl font-bold text-gray-800 mb-6 text-center">Inst√§llningar ‚öôÔ∏è</h2>
                
                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-700 font-medium">Nedr√§kning (3,2,1)</span>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="toggle-countdown" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked onchange="updateSettings()"/>
                        <label for="toggle-countdown" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-4">
                    <span class="text-gray-700 font-medium">Visa sifferpanel</span>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="toggle-numpad" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" checked onchange="updateSettings()"/>
                        <label for="toggle-numpad" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>

                <div class="flex items-center justify-between mb-6">
                    <span class="text-gray-700 font-medium">Omstart med R</span>
                    <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                        <input type="checkbox" name="toggle" id="toggle-restart" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer" onchange="updateSettings()"/>
                        <label for="toggle-restart" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label>
                    </div>
                </div>

                <div class="mb-6 text-center">
                    <div class="mb-2">
                        <span class="text-gray-700 font-medium">Visa "Tips" knapp efter</span>
                    </div>
                    <div class="bg-gray-200 p-1 rounded-lg inline-flex toggle-group">
                        <button id="ansdelay-5" onclick="setAnswerDelay(5)" class="toggle-btn-opt">5 s</button>
                        <button id="ansdelay-7" onclick="setAnswerDelay(7)" class="toggle-btn-opt">7 s</button>
                        <button id="ansdelay-10" onclick="setAnswerDelay(10)" class="toggle-btn-opt">10 s</button>
                        <button id="ansdelay-15" onclick="setAnswerDelay(15)" class="toggle-btn-opt">15 s</button>
                    </div>
                </div>

                <div class="mb-8 text-center">
                    <div class="mb-2">
                        <span class="text-gray-700 font-medium">Visa n√§sta fr√•ga</span>
                    </div>
                    <div class="bg-gray-200 p-1 rounded-lg inline-flex toggle-group">
                        <button id="nextq-0" onclick="setNextQLevel(0)" class="toggle-btn-opt">0</button>
                        <button id="nextq-1" onclick="setNextQLevel(1)" class="toggle-btn-opt">1</button>
                        <button id="nextq-2" onclick="setNextQLevel(2)" class="toggle-btn-opt">2</button>
                        <button id="nextq-3" onclick="setNextQLevel(3)" class="toggle-btn-opt">3</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2 italic text-center" id="nextq-info">Inget visas.</p>
                </div>

                <button onclick="$('settings-modal').classList.add('hidden')" class="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-gray-900 transition">Klar</button>
            </div>
        </div>

        <!-- 7. INFO MODAL -->
        <div id="info-modal" class="hidden absolute inset-0 bg-gray-500 bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-xl p-6 w-80 max-w-full mx-4 text-center">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Information ‚ÑπÔ∏è</h2>
                <div class="text-left text-sm text-gray-600 mb-6 space-y-2">
                    <p><strong>Kortkommandon i startmenyn:</strong></p>
                    <ul class="list-disc pl-4">
                        <li><strong>3</strong> - Starta 3 min tabelltr√§ning</li>
                        <li><strong>5</strong> - Starta 5 min tabelltr√§ning</li>
                        <li><strong>7</strong> - Starta 7 min tabelltr√§ning</li>
                        <li><strong>0</strong> - Starta 10 min tabelltr√§ning</li>
                    </ul>
                    <p class="mt-2"><strong>Under spel:</strong></p>
                    <ul class="list-disc pl-4">
                        <li><strong>ESC</strong> - Avbryt spelet och g√• till menyn</li>
                        <li><strong>R</strong> - Starta om spelet (om aktiverat i inst√§llningar)</li>
                    </ul>
                </div>
                <button onclick="$('info-modal').classList.add('hidden')" class="bg-gray-800 text-white font-bold py-2 rounded-lg hover:bg-gray-900 transition w-full">St√§ng</button>
            </div>
        </div>

        <!-- 8. STATISTICS VIEW -->
        <div id="stats-view" class="hidden p-6 view-section">
             <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Din Statistik üìä</h2>
             
             <div class="bg-blue-50 border border-blue-100 rounded-xl p-4 mb-6 text-center shadow-sm">
                 <p class="text-gray-500 text-xs uppercase tracking-wider font-semibold mb-1">Totalt antal l√∂sta uppgifter (Endast 1-10)</p>
                 <p id="stats-total-count" class="text-4xl font-extrabold text-blue-600">0</p>
             </div>

             <h3 class="text-lg font-bold mb-4 text-gray-700">√ñvade tabeller (1-10)</h3>
             <div id="stats-bars-container" class="space-y-3 mb-8"></div>
             
             <p class="text-xs text-gray-400 italic text-center mb-6 max-w-xs mx-auto">* Statistiken r√§knar endast uppgifter d√§r b√•da talen √§r mellan 1-10.</p>

             <div class="text-center">
                 <button onclick="showView('start-menu-view')" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-medium py-3 px-8 rounded-lg transition">Tillbaka till menyn</button>
             </div>
        </div>

        <!-- 9. SAVE/LOAD MODAL -->
        <div id="save-load-modal" class="hidden absolute inset-0 bg-gray-500 bg-opacity-50 z-50 flex items-center justify-center">
            <div class="bg-white rounded-xl shadow-xl p-6 w-80 max-w-full mx-4 text-center">
                <h2 class="text-xl font-bold text-gray-800 mb-2">Spara / Ladda üíæ</h2>
                <p class="text-sm text-gray-500 mb-6">Spara dina po√§ng och inst√§llningar till en fil, eller ladda in dem igen.</p>
                
                <div class="space-y-3">
                    <button onclick="exportData()" class="w-full bg-blue-100 text-blue-700 border border-blue-200 font-bold py-3 rounded-lg hover:bg-blue-200 transition flex items-center justify-center gap-2">
                        <span>Spara till fil</span>
                        <!-- Down Arrow (Download) -->
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5 12 21m0 0-7.5-7.5M12 21V3" /></svg>
                    </button>

                    <div class="relative">
                        <input type="file" id="import-file" class="hidden" accept=".json" onchange="importData(this)">
                        <button onclick="$('import-file').click()" class="w-full bg-green-100 text-green-700 border border-green-200 font-bold py-3 rounded-lg hover:bg-green-200 transition flex items-center justify-center gap-2">
                            <span>Ladda fr√•n fil</span>
                            <!-- Up Arrow (Upload) -->
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 10.5 12 3m0 0 7.5 7.5M12 3v18" /></svg>
                        </button>
                    </div>
                </div>
                <button onclick="$('save-load-modal').classList.add('hidden')" class="mt-6 text-gray-400 hover:text-gray-600 text-sm underline">St√§ng</button>
            </div>
        </div>
    </div>

    <script>
        const $ = id => document.getElementById(id);
        const $$ = s => document.querySelectorAll(s);
        
        let settings = {};
        let questions = [];
        let currIdx = 0;
        let startTime = 0;
        let questionStartTime = 0; 
        let gameMode = 'practice';
        let timerInterval;
        let answerTimer;
        let score = 0;
        let pendingRecord = null;
        let questionHistory = []; 
        let currentQ = null;
        let nextQObj = null;
        let followingQObj = null;
        let following2QObj = null;
        let activeInputId = null; 
        
        // Defaults
        let enableCountdown = true;
        let enableQuickRestart = false; // "Omstart med R" - Standard: Av
        let nextQLevel = 0; // 0=Av, 1=N√§sta, 2=N√§sta+F√∂ljande, 3=+ en till (Standard: 0)
        let showNumpad = true; // Standard: P√•
        let answerDelay = 7; // Sekunder

        const ops = {
            plus: { sym: '+', calc: (a,b) => a+b },
            minus: { sym: '-', calc: (a,b) => a-b },
            multiply: { sym: '√ó', calc: (a,b) => a*b },
            divide: { sym: '√∑' }, 
            power: { sym: 'power' }, // Special rendering
            modulo: { sym: 'modulo' } // Special rendering
        };

        const randInt = (min, max) => {
            const [a, b] = [Math.min(min, max), Math.max(min, max)];
            return Math.floor(Math.random() * (b - a + 1)) + a;
        };

        function generateChecksum(str) {
            let hash = 0; if (str.length === 0) return hash;
            for (let i = 0; i < str.length; i++) { const chr = str.charCodeAt(i); hash = ((hash << 5) - hash) + chr; hash |= 0; }
            return hash;
        }

        function exportData() {
            const data = { toplist: localStorage.getItem('mattespel_toplist'), stats: localStorage.getItem('mattespel_stats'), settings: { enableCountdown, enableQuickRestart, nextQLevel, showNumpad, answerDelay } };
            const json = JSON.stringify(data); const checksum = generateChecksum(json); const encoded = btoa(encodeURIComponent(checksum + "|" + json));
            const blob = new Blob([encoded], {type: "application/json"}); const url = URL.createObjectURL(blob); const a = document.createElement('a');
            a.href = url; a.download = `mattespel_data_${new Date().toISOString().slice(0,10)}.json`; a.click(); URL.revokeObjectURL(url);
            $('save-load-modal').classList.add('hidden');
        }

        function importData(input) {
            const file = input.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const decoded = decodeURIComponent(atob(e.target.result)); const separatorIdx = decoded.indexOf("|");
                    if (separatorIdx === -1) throw new Error("Invalid format");
                    const checksum = parseInt(decoded.substring(0, separatorIdx)); const json = decoded.substring(separatorIdx + 1);
                    if (generateChecksum(json) !== checksum) throw new Error("Checksum mismatch");
                    
                    const data = JSON.parse(json);
                    if (data.toplist) localStorage.setItem('mattespel_toplist', data.toplist);
                    if (data.stats) localStorage.setItem('mattespel_stats', data.stats);
                    
                    if (data.settings) { 
                        enableCountdown = data.settings.enableCountdown; enableQuickRestart = data.settings.enableQuickRestart; nextQLevel = data.settings.nextQLevel || 0; showNumpad = data.settings.showNumpad;
                        answerDelay = data.settings.answerDelay || 7;
                        $('toggle-countdown').checked = enableCountdown; $('toggle-restart').checked = enableQuickRestart; setNextQLevel(nextQLevel); $('toggle-numpad').checked = showNumpad;
                        setAnswerDelay(answerDelay);
                    }
                    alert("Data laddad! üéâ"); $('save-load-modal').classList.add('hidden');
                } catch (err) { alert("Kunde inte ladda filen. Den kan vara skadad eller manipulerad."); } input.value = ''; 
            }; reader.readAsText(file);
        }

        function getStats() { try { return JSON.parse(localStorage.getItem('mattespel_stats')) || { total: 0, tables: Array(11).fill(0) }; } catch { return { total: 0, tables: Array(11).fill(0) }; } }
        function saveStats(stats) { localStorage.setItem('mattespel_stats', JSON.stringify(stats)); }

        function updateStats(n1, n2, op) {
            // New logic: Only count table 1-10, exclude 0. Only when BOTH numbers are 1-10.
            if (op !== 'multiply') return;
            if (n1 < 1 || n1 > 10 || n2 < 1 || n2 > 10) return;

            const stats = getStats(); stats.total++;
            const countTable = (n) => { if (n >= 1 && n <= 10) stats.tables[n] = (stats.tables[n] || 0) + 1; };
            countTable(n1); if (n1 !== n2) countTable(n2); saveStats(stats);
        }
        
        function closeAllModals() { ['settings-modal', 'info-modal', 'save-load-modal'].forEach(id => $(id).classList.add('hidden')); }

        function showView(id) { 
            closeAllModals(); 
            $$('.view-section').forEach(v => v.classList.add('hidden')); 
            $(id).classList.remove('hidden');
            // Hide Top Menu unless in Start Menu
            const topMenu = document.getElementById('top-menu');
            if (topMenu) {
                if (id === 'start-menu-view') topMenu.classList.remove('hidden');
                else topMenu.classList.add('hidden');
            }
        }
        
        function showStatsView() {
            closeAllModals(); const stats = getStats(); $('stats-total-count').textContent = stats.total; const container = $('stats-bars-container'); container.innerHTML = ''; const maxVal = Math.max(...stats.tables, 1);
            // Only show 1-10
            for(let num=1; num<=10; num++) {
                const count = stats.tables[num] || 0;
                const percent = (count / maxVal) * 100; const barWidth = Math.max(percent, 1);
                container.innerHTML += `<div class="flex items-center"><div class="w-8 text-sm font-bold text-gray-600 text-right mr-3">${num}</div><div class="flex-1 bg-gray-100 rounded-full h-4 overflow-hidden relative"><div class="h-full bg-blue-500 rounded-full" style="width: ${barWidth}%"></div></div><div class="w-10 text-xs text-gray-500 text-left ml-3">${count}</div></div>`;
            }
            showView('stats-view');
        }

        function showSettings() { closeAllModals(); $('settings-modal').classList.remove('hidden'); updateSettings(); }
        function showInfoModal() { closeAllModals(); $('info-modal').classList.remove('hidden'); }
        function showSaveLoadModal() { closeAllModals(); $('save-load-modal').classList.remove('hidden'); }
        
        function updateSettings() {
            enableCountdown = $('toggle-countdown').checked; enableQuickRestart = $('toggle-restart').checked; showNumpad = $('toggle-numpad').checked;
            
            // Next Q logic handled by setNextQLevel
        }
        
        function setAnswerDelay(sec) {
            answerDelay = sec;
            $$('.toggle-btn-opt').forEach(el => {
                if(el.id.startsWith('ansdelay')) el.classList.remove('active');
            });
            $(`ansdelay-${sec}`).classList.add('active');
        }

        function setNextQLevel(lvl) {
            nextQLevel = lvl;
            $$('.toggle-btn-opt').forEach(el => {
                if(el.id.startsWith('nextq')) el.classList.remove('active');
            });
            $(`nextq-${lvl}`).classList.add('active');
            
            const info = $('nextq-info');
            if (lvl === 0) info.textContent = "Inget visas.";
            else if (lvl === 1) info.textContent = "Visar n√§sta uppgift.";
            else if (lvl === 2) info.textContent = "Visar de tv√• f√∂ljande uppgifterna. Endast tillg√§ngligt i spell√§gena Tabelltr√§ning och T√§vla.";
            else if (lvl === 3) info.textContent = "Visar de tre f√∂ljande uppgifterna. Endast tillg√§ngligt i spell√§gena Tabelltr√§ning och T√§vla.";
            
            updatePreviewVisibility();
        }

        function updatePreviewVisibility() {
            const nextEls = $$('.next-q-el');
            const folEls = $$('.fol-q-el');
            const fol2Els = $$('.fol2-q-el');
            
            // Reset
            nextEls.forEach(el => el.classList.add('opacity-0'));
            folEls.forEach(el => el.classList.add('hidden'));
            fol2Els.forEach(el => el.classList.add('hidden'));

            if (nextQLevel >= 1) {
                nextEls.forEach(el => el.classList.remove('opacity-0'));
            }
            
            if (gameMode === 'table-training' || gameMode.startsWith('compete') || gameMode === 'practice-table-fixed') {
                if (nextQLevel >= 2) {
                    folEls.forEach(el => {
                        el.classList.remove('hidden');
                        el.classList.remove('opacity-0');
                    });
                }
                if (nextQLevel >= 3) {
                    fol2Els.forEach(el => {
                        el.classList.remove('hidden');
                        el.classList.remove('opacity-0');
                    });
                }
            }
        }

        function initTableButtons(containerId) {
            const container = $(containerId); container.innerHTML = '';
            for(let i=0; i<=10; i++) {
                const btn = document.createElement('button'); btn.className = 'table-btn'; btn.textContent = i;
                if (containerId === 'training-tables-selection' && i > 0) btn.classList.add('selected');
                btn.onclick = () => { btn.classList.toggle('selected'); if (containerId === 'specific-tables-selection') updateBtn(); };
                container.appendChild(btn);
            }
        }
        
        function initPctSelection() {
            const grid = $('pct-selection-grid'); grid.innerHTML = '';
            const pcts = [1,2,3,4,5,6,7,8,9,10,20,30,40,50,60,70,80,90,100];
            pcts.forEach(p => {
                const btn = document.createElement('div'); btn.className = 'pct-btn'; btn.textContent = p + ' %'; btn.dataset.val = p;
                btn.onclick = () => { btn.classList.toggle('selected'); };
                grid.appendChild(btn);
            });

            const numGrid = $('pct-num-selection-grid'); numGrid.innerHTML = '';
            const nums = [10,20,30,40,50,60,70,80,90,100,200,300,400,500,600,700,800,900];
            nums.forEach(n => {
                const btn = document.createElement('div'); btn.className = 'pct-btn'; btn.textContent = n; btn.dataset.val = n;
                btn.onclick = () => { btn.classList.toggle('selected'); };
                numGrid.appendChild(btn);
            });
        }
        
        function toggleAll(type) {
            const selector = type === 'pct' ? '#pct-selection-grid .pct-btn' : '#pct-num-selection-grid .pct-btn';
            const btns = $$(selector);
            const allSelected = Array.from(btns).every(b => b.classList.contains('selected'));
            btns.forEach(b => {
                if (allSelected) b.classList.remove('selected');
                else b.classList.add('selected');
            });
        }
        
        let practiceModeType = 'count';
        function togglePracticeMode(mode) {
            practiceModeType = mode;
            const countInput = $('practice-count-input'); const timeInput = $('practice-time-input'); const btnCount = $('practice-mode-count'); const btnTime = $('practice-mode-time');
            
            if (mode === 'count') {
                countInput.classList.remove('hidden'); timeInput.classList.add('hidden');
                btnCount.className = "px-4 py-2 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition"; btnTime.className = "px-4 py-2 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition";
            } else {
                countInput.classList.add('hidden'); timeInput.classList.remove('hidden');
                btnTime.className = "px-4 py-2 rounded-md text-sm font-bold bg-white shadow text-gray-800 transition"; btnCount.className = "px-4 py-2 rounded-md text-sm font-bold text-gray-600 hover:bg-gray-300 transition";
                // Populate select if empty
                const sel = $('practice-time-select');
                if (sel.options.length === 0) {
                    for(let i=1; i<=15; i++) {
                        const opt = document.createElement('option'); opt.value = i; opt.textContent = i + " min";
                        if(i===3) opt.selected = true;
                        sel.appendChild(opt);
                    }
                }
            }
            updateBtn();
        }
        
        function numpadPress(num) {
            const input = document.getElementById(activeInputId);
            if (input) { input.value = input.value + num; const event = new Event('input', { bubbles: true }); input.dispatchEvent(event); input.focus(); }
        }
        function numpadBackspace() {
             const input = document.getElementById(activeInputId);
             if (input) { input.value = input.value.slice(0, -1); const event = new Event('input', { bubbles: true }); input.dispatchEvent(event); input.focus(); }
        }
        
        // Helper UI functions
        function toggleTableMode() {
            const isChecked = $('use-specific-tables').checked;
            if(isChecked) $('specific-tables-selection').classList.remove('hidden');
            else $('specific-tables-selection').classList.add('hidden');
            toggleIntervals(); // Re-check intervals visibility
            updateBtn();
        }

        function toggleIntervals() {
            const ops = Array.from($$('#operator-container .selected')).map(b => b.dataset.op);
            const standardOps = ['plus', 'minus', 'multiply', 'divide'];
            const hasStandard = ops.some(op => standardOps.includes(op));
            const hasPower = ops.includes('power');
            const hasModulo = ops.includes('modulo');
            const onlyMultiply = ops.length === 1 && ops[0] === 'multiply';
            const specificTable = $('use-specific-tables').checked;

            // Hide standard intervals if we are doing specific multiplication table practice
            if (onlyMultiply && specificTable) {
                $('interval-container').classList.add('hidden');
            } else if (hasStandard || (!hasPower && !hasModulo)) {
                $('interval-container').classList.remove('hidden');
            } else {
                $('interval-container').classList.add('hidden');
            }

            if (hasPower) $('sq-interval-container').classList.remove('hidden');
            else $('sq-interval-container').classList.add('hidden');

            if (hasModulo) $('pct-interval-container').classList.remove('hidden');
            else $('pct-interval-container').classList.add('hidden');
            
            // Table practice wrapper visibility
            if (onlyMultiply) $('table-practice-wrapper').classList.remove('hidden');
            else {
                $('table-practice-wrapper').classList.add('hidden');
                $('use-specific-tables').checked = false;
                if($('specific-tables-selection')) $('specific-tables-selection').classList.add('hidden');
            }
            updateBtn();
        }

        function updateBtn() {
            const ops = Array.from($$('#operator-container .selected'));
            const playBtn = $('play-btn');
            if (ops.length === 0) {
                playBtn.disabled = true;
                playBtn.classList.add('opacity-50', 'cursor-not-allowed');
            } else {
                playBtn.disabled = false;
                playBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        function nextQ() {
            clearTimeout(answerTimer);
            const btn = $('answer-helper-btn');
            if (btn) {
                btn.classList.remove('visible');
                btn.textContent = "Tips"; // Reset text
            }
            
            // Reset Tips Mode if active
            $('tips-container').classList.add('hidden');
            $('numpad-container').classList.add('hidden'); // Logic below decides visibility
            $('input-area').classList.remove('hidden');

            if (settings.count !== Infinity && currIdx >= settings.count) { endGame(); return; }
            
            if (settings.count === Infinity) {
                while (questions.length <= currIdx + 3) addRandomQuestion();
            }
            
            currentQ = questions[currIdx];
            nextQObj = (settings.count !== Infinity && currIdx + 1 >= settings.count) ? null : questions[currIdx + 1];
            followingQObj = (settings.count !== Infinity && currIdx + 2 >= settings.count) ? null : questions[currIdx + 2];
            following2QObj = (settings.count !== Infinity && currIdx + 3 >= settings.count) ? null : questions[currIdx + 3];
            
            questionStartTime = performance.now();
            if (settings.count === Infinity) $('q-counter').textContent = `Po√§ng: ${score}`;
            else $('q-counter').textContent = `${currIdx + 1} av ${settings.count}`;
            
            renderQuestion(currentQ);
            renderNextPreview(nextQObj, followingQObj, following2QObj);
            updateSettings(); 
            updatePreviewVisibility(); // Ensure levels respected
            
            // Show Numpad if set (and not currently in tips mode which is hidden anyway)
            if (showNumpad) $('numpad-container').classList.remove('hidden');

            // Answer helper logic (Only in Table training or Specific table practice)
            if (gameMode === 'table-training' || gameMode === 'practice-table-fixed') {
                answerTimer = setTimeout(() => {
                    const btn = $('answer-helper-btn');
                    if(btn) btn.classList.add('visible');
                }, answerDelay * 1000);
            }
        }

        function showTips() {
            // Hide input area and numpad
            $('input-area').classList.add('hidden');
            $('numpad-container').classList.add('hidden');
            
            const container = $('tips-container');
            container.innerHTML = '';
            container.classList.remove('hidden');
            
            const correctAns = currentQ.ans;
            
            // 1. Generate Smart Candidates Pool
            let candidateSet = new Set();
            
            if (currentQ.op === 'multiply') {
                // Table neighbors for BOTH factors (n1 and n2)
                [currentQ.n1, currentQ.n2].forEach(factor => {
                    if (factor === 0) return; // Avoid 0 steps
                    // +/- 1 step
                    candidateSet.add(correctAns + factor);
                    candidateSet.add(correctAns - factor);
                    // +/- 2 steps
                    candidateSet.add(correctAns + (factor * 2));
                    candidateSet.add(correctAns - (factor * 2));
                });
            }
            
            // Random close numbers for all types (including multiply to fill gaps)
            for (let i = 0; i < 10; i++) {
                const offset = randInt(1, 6) * (Math.random() < 0.5 ? 1 : -1);
                candidateSet.add(correctAns + offset);
            }

            // Filter candidates: [1, 100], unique, != correctAns
            let pool = Array.from(candidateSet).filter(n => 
                n >= 1 && n <= 100 && n !== correctAns && (Number.isInteger(n) || currentQ.op === 'modulo')
            );
            
            // Split into Smaller and Larger pools
            let smallerPool = pool.filter(n => n < correctAns);
            let largerPool = pool.filter(n => n > correctAns);
            
            // 2. Determine Rank (0=Smallest ... 3=Largest)
            const rank = Math.floor(Math.random() * 4); 
            const neededSmaller = rank; 
            const neededLarger = 3 - rank;
            
            let options = [correctAns];
            
            // Helper to fill options
            const fillOptions = (sourcePool, count, isSmaller) => {
                let selected = [];
                // Shuffle source pool
                sourcePool.sort(() => Math.random() - 0.5);
                
                // Take from pool
                for (let num of sourcePool) {
                    if (selected.length >= count) break;
                    if (!options.includes(num)) selected.push(num);
                }
                
                // If not enough, generate random valid numbers
                let attempts = 0;
                while (selected.length < count && attempts < 200) {
                    attempts++;
                    let rnd;
                    if (isSmaller) {
                        // Generate number between 1 and correctAns-1
                        if (correctAns <= 1) break; 
                        rnd = randInt(1, Math.floor(correctAns) - 1); 
                        if (currentQ.op === 'modulo') rnd = parseFloat((Math.random() * (correctAns - 1) + 1).toFixed(1)); 
                        else rnd = randInt(1, Math.floor(correctAns) - 1);
                    } else {
                        // Generate number between correctAns+1 and 100
                        if (correctAns >= 100) break;
                        rnd = randInt(Math.floor(correctAns) + 1, 100);
                    }
                    
                    if (rnd >= 1 && rnd <= 100 && rnd !== correctAns && !options.includes(rnd) && !selected.includes(rnd)) {
                        selected.push(rnd);
                    }
                }
                return selected;
            };
            
            const chosenSmaller = fillOptions(smallerPool, neededSmaller, true);
            const chosenLarger = fillOptions(largerPool, neededLarger, false);
            
            options = options.concat(chosenSmaller).concat(chosenLarger);
            
            // Fallback: If we still don't have 4 options
            while (options.length < 4) {
                let rnd = randInt(1, 100);
                if (!options.includes(rnd) && rnd !== correctAns) options.push(rnd);
            }
            
            // Shuffle final display order
            options.sort(() => Math.random() - 0.5);
            
            // Create Buttons
            options.forEach(opt => {
                const btn = document.createElement('div');
                btn.className = 'tips-option';
                
                if (typeof opt === 'number' && !Number.isInteger(opt)) btn.textContent = opt.toString().replace('.', ',');
                else btn.textContent = opt;
                
                btn.onclick = () => {
                    if (opt === correctAns) {
                        btn.className += ' correct';
                        // Correct logic
                        if (currentQ.op === 'multiply') updateStats(currentQ.n1, currentQ.n2, currentQ.op);
                        const timeTaken = (performance.now() - questionStartTime) / 1000;
                        let qt = ""; 
                        if (currentQ.op === 'power') qt = `${currentQ.n1}¬≤`; 
                        else if (currentQ.op === 'modulo') qt = `${currentQ.n1}% av ${currentQ.n2}`; 
                        else qt = `${currentQ.n1} ${ops[currentQ.op].sym} ${currentQ.n2}`;
                        
                        questionHistory.push({ n1: currentQ.n1, n2: currentQ.n2, time: timeTaken, qText: qt });
                        score++; currIdx++; 
                        
                        setTimeout(() => { 
                            nextQ(); 
                        }, 500);
                    } else {
                        btn.className += ' wrong';
                    }
                };
                container.appendChild(btn);
            });
        }
        
        function addRandomQuestion() {
            const op = settings.ops[questions.length % settings.ops.length];
            const prev = questions.length > 0 ? questions[questions.length - 1] : null;
            questions.push(getNextRandomQ(op, prev));
        }

        function getNextRandomQ(op, prevQ = null) {
            let newQ; let attempts = 0;
            do { newQ = genQWrapper(op); attempts++; } while (prevQ && newQ.n1 === prevQ.n1 && newQ.n2 === prevQ.n2 && attempts < 10);
            return newQ;
        }

        function genQWrapper(op) {
             if (op === 'power') return genQ(op, settings.sqR, null);
             if (op === 'modulo') {
                 // Modulo specific override
                 return genQ(op, null, null);
             }
             if (op === 'multiply' && settings.specificTables && settings.specificTables.length > 0) return genQ(op, null, null);
             return genQ(op, settings.lR, settings.rR);
        }

        function genQ(op, r1, r2) {
            let n1, n2, ans;
            if (settings.specificTables && settings.specificTables.length > 0 && op === 'multiply') {
                const table = settings.specificTables[Math.floor(Math.random() * settings.specificTables.length)];
                const other = Math.floor(Math.random() * 10) + 1; 
                if (Math.random() < 0.5) { n1 = table; n2 = other; } else { n1 = other; n2 = table; }
                ans = n1 * n2; return { n1, n2, op, ans };
            }

            if (op === 'modulo') {
                const pcts = settings.pcts && settings.pcts.length > 0 ? settings.pcts : [10,20,50];
                const nums = settings.pctNums && settings.pctNums.length > 0 ? settings.pctNums : [100,200];
                n1 = pcts[Math.floor(Math.random() * pcts.length)];
                n2 = nums[Math.floor(Math.random() * nums.length)];
                // Exact calculation
                ans = (n1 * n2) / 100;
                // If it ends up floating, javascript handles it. 
                // e.g. 5% of 30 = 1.5
                return { n1, n2, op, ans };
            }

            const min1 = r1 ? Math.max(0, Math.min(r1.min, r1.max)) : 0; const max1 = r1 ? Math.max(0, Math.max(r1.min, r1.max)) : 0;
            const min2 = r2 ? Math.max(0, Math.min(r2.min, r2.max)) : 0; const max2 = r2 ? Math.max(0, Math.max(r2.min, r2.max)) : 0;

            if (op === 'divide') {
                n1 = randInt(min1, max1); n2 = randInt(Math.max(1, min2), max2); const q = Math.floor(n1 / n2); const r = n1 % n2; ans = (r === 0) ? q : { q: q, r: r };
            } else if (op === 'power') { n1 = randInt(min1, max1); n2 = null; ans = n1 * n1;
            } else { n1 = randInt(min1, max1); n2 = randInt(min2, max2); ans = ops[op].calc(n1, n2); }
            return { n1, n2, op, ans };
        }

        function renderQuestion(q) {
            $('op1').textContent = q.n1; 
            const sym = $('op-sym'); 
            
            // Reset styles
            sym.className = "op-col text-5xl md:text-6xl font-extrabold text-gray-900";
            $('op1').className = "val-col-r text-5xl md:text-6xl font-extrabold text-gray-900";
            
            if (q.op === 'power') {
                sym.innerHTML = ''; // Clear text
                // Use a span with negative top margin to push it up
                // Increasing the negative top value to really push it up
                sym.innerHTML = '<span class="text-4xl" style="position:relative; top: -30px; left: -10px;">2</span>';
                sym.className = "op-col font-extrabold text-gray-900 w-4"; // Make it narrow
                $('op1').textContent = q.n1;
                
            } else {
                sym.textContent = ops[q.op].sym; 
            }
            
            if (q.op === 'modulo') {
                $('hint-text').textContent = '';
                // % symbol big, av small
                sym.innerHTML = '<span class="text-5xl md:text-6xl font-extrabold">%</span> <span class="text-2xl font-normal text-gray-500 ml-2">av</span>';
                sym.className = "text-center w-auto px-2 font-extrabold text-gray-900 whitespace-nowrap";
            } else {
                $('hint-text').textContent = '';
            }
            
            $('op2').textContent = (q.n2 !== null && q.op !== 'power') ? q.n2 : ''; 
            
            const area = $('input-area'); area.innerHTML = ''; 
            
            // Create a wrapper to hold inputs and ensure the button positions relative to THEM, not the full width container
            const wrapper = document.createElement('div');
            wrapper.className = 'relative inline-flex items-center justify-center gap-2'; // inline-flex hugs content
            
            if (typeof q.ans === 'object') {
                const i1 = createInput('q-input', 'w-24'); const span = document.createElement('span'); span.textContent = 'rest'; span.className = 'text-xl font-medium text-gray-500 pb-1'; const i2 = createInput('r-input', 'w-24');
                i1.oninput = (e) => { if (parseInt(e.target.value) === q.ans.q) i2.focus(); checkAns(); }; i2.oninput = checkAns; i1.onkeyup = (e) => { if(e.key === 'Enter') i2.focus(); }; i2.onkeyup = (e) => { if(e.key === 'Enter') checkAns(); }; 
                wrapper.append(i1, span, i2); 
                // Set focus logic after append
                setTimeout(() => i1.focus(), 0); 
                activeInputId = 'q-input';
            } else { 
                const i1 = createInput('std-input', 'w-40'); 
                // Allow comma
                i1.type = "text"; 
                i1.setAttribute('inputmode', 'decimal'); 
                i1.oninput = checkAns; i1.onkeyup = (e) => { if(e.key === 'Enter') checkAns(); }; 
                wrapper.append(i1); 
                setTimeout(() => i1.focus(), 0);
                activeInputId='std-input'; 
            }
            
            // Create dynamic answer button container
            const btnContainer = document.createElement('div');
            btnContainer.id = 'tips-btn-wrapper';
            
            const btn = document.createElement('button');
            btn.id = 'answer-helper-btn';
            btn.textContent = 'Tips';
            btn.onclick = showTips;
            
            btnContainer.appendChild(btn);
            wrapper.appendChild(btnContainer); // Append to wrapper
            
            area.appendChild(wrapper); // Append wrapper to main area
        }

        function renderNextPreview(q, fq, fq2) {
            renderSinglePreview(q, 'next');
            renderSinglePreview(fq, 'fol');
            renderSinglePreview(fq2, 'fol2');
        }

        function renderSinglePreview(q, prefix) {
            const op1 = $(`${prefix}-op1`); const sym = $(`${prefix}-sym`); const op2 = $(`${prefix}-op2`);
            
            if (!q) { 
                op1.textContent = ""; sym.textContent = ""; op2.textContent = ""; 
                return; 
            }
            
            op1.textContent = q.n1;
            
            // Reset preview styles
            sym.className = `op-col text-4xl font-bold text-gray-400 transition-opacity ${prefix}-q-el`;
            
            if (q.op === 'power') {
                // Raise the preview exponent as well
                sym.innerHTML = '<span class="text-2xl" style="position:relative; top: -15px; left: -5px;">2</span>';
                sym.className = `op-col w-4 font-bold text-gray-400 transition-opacity ${prefix}-q-el`;
                op2.textContent = "";
            } else if (q.op === 'modulo') {
                sym.textContent = '% av';
                sym.className = `text-center w-auto px-2 text-xl font-bold text-gray-300 whitespace-nowrap ${prefix}-q-el`; 
                op2.textContent = q.n2;
            } else {
                sym.textContent = ops[q.op].sym;
                op2.textContent = q.n2;
            }
        }

        function createInput(id, widthClass) { const i = document.createElement('input'); i.type = 'number'; i.id = id; i.className = `game-input ${widthClass}`; i.setAttribute('autocomplete', 'off'); i.onfocus = () => { activeInputId = id; }; return i; }
        
        function checkAns() {
            let isCorrect = false;
            if (typeof currentQ.ans === 'object') { const qVal = parseInt($('q-input')?.value); const rVal = parseInt($('r-input')?.value); if (!isNaN(qVal) && !isNaN(rVal) && qVal === currentQ.ans.q && rVal === currentQ.ans.r) isCorrect = true; } 
            else { 
                let valStr = $('std-input')?.value || "";
                valStr = valStr.replace(',', '.'); // Handle comma
                const val = parseFloat(valStr); 
                
                // Precision check for floats
                if (!isNaN(val) && Math.abs(val - currentQ.ans) < 0.000001) isCorrect = true; 
            }

            if (isCorrect) { 
                if (currentQ.op === 'multiply') updateStats(currentQ.n1, currentQ.n2, currentQ.op);
                const timeTaken = (performance.now() - questionStartTime) / 1000;
                let qt = ""; 
                if (currentQ.op === 'power') qt = `${currentQ.n1}¬≤`; 
                else if (currentQ.op === 'modulo') qt = `${currentQ.n1}% av ${currentQ.n2}`; 
                else qt = `${currentQ.n1} ${ops[currentQ.op].sym} ${currentQ.n2}`;
                
                questionHistory.push({ n1: currentQ.n1, n2: currentQ.n2, time: timeTaken, qText: qt });
                score++; currIdx++; setTimeout(() => { nextQ(); }, 10);
            }
        }

        function endGame() {
            clearInterval(timerInterval);
            clearTimeout(answerTimer);
            if (gameMode === 'table-training') { showTableTrainingResults(); return; }
            if (gameMode.startsWith('compete')) {
                const cat = gameMode === 'compete-time' ? 'time' : settings.competeCategory;
                const result = gameMode === 'compete-time' ? score : (performance.now() - startTime) / 1000;
                if (checkIfHighScore(cat, result)) { pendingRecord = { cat, result }; showRecordInput(result, gameMode === 'compete-time'); return; }
            }
            showNormalResults();
        }

        // Helpers
        function showTableTrainingResults() {
            const totalCount = score; const avgSpeed = questionHistory.length > 0 ? (questionHistory.reduce((sum, item) => sum + item.time, 0) / questionHistory.length) : 0;
            $('tt-total-count').textContent = totalCount; $('tt-avg-speed').textContent = avgSpeed.toFixed(2).replace('.', ',');
            
            const tableStats = {};
            questionHistory.forEach(item => {
                if (!tableStats[item.n1]) tableStats[item.n1] = { totalTime: 0, count: 0 }; tableStats[item.n1].totalTime += item.time; tableStats[item.n1].count++;
                if (item.n1 !== item.n2) { if (!tableStats[item.n2]) tableStats[item.n2] = { totalTime: 0, count: 0 }; tableStats[item.n2].totalTime += item.time; tableStats[item.n2].count++; }
            });
            
            let best = {avg:Infinity, t:'-'}, worst={avg:0, t:'-'};
            (settings.specificTables||[]).forEach(t=>{
                if(tableStats[t]){ const a = tableStats[t].totalTime/tableStats[t].count; if(a<best.avg) best={avg:a, t:t}; if(a>worst.avg) worst={avg:a, t:t}; }
            });

            $('tt-best-table').textContent = best.t!=='-'?`${best.t}:ans (${best.avg.toFixed(2).replace('.',',')}s)`:'-'; $('tt-worst-table').textContent = worst.t!=='-'?`${worst.t}:ans (${worst.avg.toFixed(2).replace('.',',')}s)`:'-';

            const uniqueQs = {};
            questionHistory.forEach(item => { const key = item.qText; if (!uniqueQs[key]) uniqueQs[key] = { qText: key, totalTime: 0, count: 0, n1: item.n1, n2: item.n2 }; uniqueQs[key].totalTime += item.time; uniqueQs[key].count++; });
            const sortedQs = Object.values(uniqueQs).sort((a, b) => (a.totalTime / a.count) - (b.totalTime / b.count));
            
            const listEl = $('tt-detail-list'); listEl.innerHTML = '';
            sortedQs.forEach(q => { const avg = q.totalTime / q.count; listEl.innerHTML += `<tr><td class="pl-4 py-1 text-gray-700 font-medium">${q.qText} <span class="text-gray-400 text-xs">(${q.count}st)</span></td><td class="pr-4 py-1 text-right text-gray-600">${avg.toFixed(2).replace('.', ',')} s</td></tr>`; });

            const hardestQs = sortedQs.slice(-Math.ceil(sortedQs.length / 4));
            if (hardestQs.length > 0) { $('tt-practice-hardest-btn').onclick = () => practiceHardest(hardestQs); $('tt-practice-hardest-btn').classList.remove('opacity-50'); } else $('tt-practice-hardest-btn').classList.add('opacity-50');
            
            if (worst.t !== '-') { $('tt-practice-worst-table-btn').textContent = `√ñva ${worst.t}:ans tabell`; $('tt-practice-worst-table-btn').classList.remove('hidden'); $('tt-practice-worst-table-btn').onclick = () => practiceSpecificTable(worst.t); } else $('tt-practice-worst-table-btn').classList.add('hidden');
            
            showView('table-training-results-view');
        }

        function showNormalResults() {
            if (gameMode === 'compete-time' || (gameMode==='practice' && settings.practiceModeType==='time')) { $('result-message').textContent = `Du klarade ${score} st!`; $('result-subtext').textContent = ""; }
            else if (gameMode === 'practice-hardest') { $('result-message').textContent = `Snyggt!`; $('result-subtext').textContent = "Du har tr√§nat p√• de sv√•raste uppgifterna."; }
            else if (gameMode === 'practice-table-fixed') { const sec = (performance.now() - startTime) / 1000; $('result-message').textContent = `Klar med tabellen!`; $('result-subtext').textContent = `Tid: ${sec.toFixed(2).replace('.', ',')} s`; }
            else { const sec = (performance.now() - startTime) / 1000; const txt = sec >= 60 ? `${Math.floor(sec/60)} min ${Math.floor(sec%60)} s` : `${sec.toFixed(2).replace('.', ',')} s`; $('result-message').textContent = `Du klarade spelet p√•:`; $('result-subtext').textContent = txt + "."; }
            showView('results-view');
        }

        function showRecordInput(r,t) { $('record-details').textContent = t ? `${r} st` : `${r.toFixed(2).replace('.',',')} s`; $('player-name').value=''; showView('record-view'); }
        function getHighScores() { return JSON.parse(localStorage.getItem('mattespel_toplist')) || { '10': [], '20': [], '42': [], 'time': [] }; }
        function saveHighScores(d) { localStorage.setItem('mattespel_toplist', JSON.stringify(d)); }
        function checkIfHighScore(c,r) { const l=getHighScores()[c]||[]; return l.length<10 || (c==='time'?r>l[l.length-1].score:r<l[l.length-1].score); }

        $('player-name').oninput = function() { this.className = this.value.length > 10 ? this.className.replace('text-xl', 'text-sm') : this.className.replace('text-sm', 'text-xl'); };
        $('save-record-btn').onclick = () => { const n = $('player-name').value.trim() || 'ANONYM'; const l=getHighScores(); const c=pendingRecord.cat; const e={name:n.toUpperCase(), score:pendingRecord.result, date:new Date().toLocaleDateString('sv-SE')}; e.spq = (c!=='time') ? (pendingRecord.result/parseInt(c)).toFixed(2).replace('.',',') : (pendingRecord.result>0?(60/pendingRecord.result).toFixed(2).replace('.',','):'-'); l[c].push(e); l[c].sort((a,b) => c==='time' ? b.score-a.score : a.score-b.score); l[c] = l[c].slice(0,10); saveHighScores(l); showToplists(c); };
        
        function showToplists(t='10') { showView('toplist-view'); renderToplist(t); }

        function renderToplist(cat) {
            $$('.tab-btn').forEach(b=>b.classList.remove('active')); const btn=Array.from($$('.tab-btn')).find(b=>b.onclick.toString().includes(cat)); if(btn)btn.classList.add('active');
            const list = getHighScores()[cat]||[];
            let h = `<table class="w-full score-table"><thead><tr><th class="w-8">#</th><th>Namn</th><th class="text-right">${cat==='time'?'Antal':'Tid'}</th><th class="text-right text-xs">s/u<span class="inline-flex justify-center items-center w-4 h-4 rounded-full bg-gray-200 text-gray-500 text-[10px] ml-1 cursor-help" title="Sekunder per uppgift">i</span></th><th class="text-right hidden sm:table-cell">Datum</th></tr></thead><tbody>`;
            list.forEach((e,i)=> { const nameClass = e.name.length > 10 ? 'text-xs' : 'text-base'; h+=`<tr class="score-row" onclick="initiateDelete('${cat}',${i})"><td class="font-bold text-gray-400">${i+1}</td><td class="font-bold text-gray-800 ${nameClass}">${e.name}</td><td class="text-right font-mono text-pink-600 font-bold">${cat==='time'?e.score+' st':e.score.toFixed(2).replace('.',',')+' s'}</td><td class="text-right text-xs text-gray-400">${e.spq||'-'}</td><td class="text-right text-xs text-gray-400 hidden sm:table-cell">${e.date}</td></tr>`; });
            $('toplist-content').innerHTML = h+'</tbody></table>';
        }

        function initiateDelete(c,i) { showConfirm("Vill du radera detta resultat?", ()=>showConfirm("√Ñr du helt s√§ker? Detta g√•r inte att √•ngra.", ()=> { const l=getHighScores(); l[c].splice(i,1); saveHighScores(l); renderToplist(c); })); }
        function showConfirm(m,cb){ let d=$('custom-confirm'); if(!d){ d=document.createElement('div'); d.id='custom-confirm'; d.style.cssText='position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:2000;'; d.innerHTML='<div style="background:white;padding:20px;border-radius:12px;width:300px;text-align:center;"><p id="c-msg" class="mb-4 text-gray-700"></p><div class="flex gap-2"><button id="c-no" class="flex-1 bg-gray-200 p-2 rounded font-bold text-gray-700">Nej</button><button id="c-yes" class="flex-1 bg-red-500 text-white p-2 rounded font-bold">Ja</button></div></div>'; document.body.appendChild(d);} d.querySelector('#c-msg').textContent=m; d.querySelector('#c-yes').onclick=()=>{d.style.display='none';cb()}; d.querySelector('#c-no').onclick=()=>{d.style.display='none'}; d.style.display='flex'; }

        function replay() {
            if (gameMode === 'compete-time') startCompetition('time');
            else if (gameMode === 'compete-fixed') startCompetition(settings.count);
            else if (gameMode === 'table-training') startLastTableTraining();
            else if (gameMode === 'practice-hardest') startLastTableTraining();
            else if (gameMode === 'practice-table-fixed') startLastTableTraining();
            else startPractice(); 
        }

        function startCompetition(type) {
            settings = { ops: ['multiply'], lR: {min: 1, max: 10}, rR: {min: 1, max: 10}, specificTables: [], practiceModeType: 'count' };
            if (type === 'time') { gameMode = 'compete-time'; settings.count = Infinity; runCountdown(() => startTimerGame(60)); }
            else { 
                gameMode = 'compete-fixed'; settings.competeCategory = type.toString(); settings.count = type; 
                questions = []; let prev = null;
                for(let i=0; i<type; i++) { const q = getNextRandomQ('multiply', prev); questions.push(q); prev = q; }
                runCountdown(() => startGameLogic(true)); 
            }
        }

        function startPractice() {
            gameMode = 'practice';
            const selectedBtns = Array.from($$('#operator-container .selected'));
            let selOps = selectedBtns.map(b => b.dataset.op).filter(op => ops[op] || op === 'divide' || op === 'power' || op === 'modulo');
            const lMin = parseInt($('left-min').value), lMax = parseInt($('left-max').value); const rMin = parseInt($('right-min').value), rMax = parseInt($('right-max').value);
            const sqMin = parseInt($('sq-min').value), sqMax = parseInt($('sq-max').value); const qCount = parseInt($('q-count').value);
            
            // Percentage selections
            const selectedPcts = Array.from($$('#pct-selection-grid .pct-btn.selected')).map(el => parseInt(el.dataset.val));
            const selectedPctNums = Array.from($$('#pct-num-selection-grid .pct-btn.selected')).map(el => parseInt(el.dataset.val));

            if (!selOps.length) return alert('V√§nligen v√§lj minst ett giltigt r√§knes√§tt!'); if ($('play-btn').disabled) return;
            
            const useSpecific = $('use-specific-tables').checked && !$('table-practice-wrapper').classList.contains('hidden');
            let specificTables = []; if (useSpecific) specificTables = Array.from($$('#specific-tables-selection .table-btn.selected')).map(b => parseInt(b.textContent));
            
            const pMode = practiceModeType; 
            const timeVal = parseInt($('practice-time-select').value) || 3;
            
            settings = { 
                ops: selOps, lR: {min: lMin, max: lMax}, rR: {min: rMin, max: rMax}, sqR: {min: sqMin, max: sqMax},
                pcts: selectedPcts, pctNums: selectedPctNums,
                count: qCount, specificTables: specificTables, practiceModeType: pMode
            };

            if (pMode === 'time') {
                settings.count = Infinity; 
                runCountdown(() => startTimerGame(timeVal * 60));
            } else {
                questions = []; let prev = null;
                for(let i=0; i<qCount; i++) {
                    const op = settings.ops[i % settings.ops.length];
                    const q = getNextRandomQ(op, prev);
                    questions.push(q); prev = q;
                }
                runCountdown(() => startGameLogic(true));
            }
        }
        
        function startTableTraining(minutes) {
            let selectedTables = [];
            if (!$('table-training-settings-view').classList.contains('hidden')) { selectedTables = Array.from($$('#training-tables-selection .table-btn.selected')).map(b => parseInt(b.textContent)); } 
            else { selectedTables = Array.from($$('#training-tables-selection .table-btn.selected')).map(b => parseInt(b.textContent)); }
            
            if (selectedTables.length === 0) selectedTables = [1,2,3,4,5,6,7,8,9,10];
            settings = { ops: ['multiply'], specificTables: selectedTables, durationMinutes: minutes, count: Infinity };
            gameMode = 'table-training';
            runCountdown(() => startTimerGame(minutes * 60));
        }

        function startLastTableTraining() {
             if (gameMode === 'practice-hardest' || gameMode === 'practice-table-fixed') { startTableTraining(settings.durationMinutes || 1); return; }
             startTableTraining(settings.durationMinutes || 1);
        }

        function practiceHardest(hardestQs) {
            gameMode = 'practice-hardest'; settings.count = hardestQs.length;
            settings.fixedQuestions = hardestQs.map(item => ({ n1: item.n1, n2: item.n2, op: 'multiply', ans: item.n1 * item.n2 }));
            runCountdown(() => startGameLogic(true));
        }

        function practiceSpecificTable(tableNum) {
            gameMode = 'practice-table-fixed'; const qs = [];
            for (let i = 1; i <= 10; i++) { qs.push({ n1: tableNum, n2: i, op: 'multiply', ans: tableNum * i }); if (i !== tableNum) qs.push({ n1: i, n2: tableNum, op: 'multiply', ans: i * tableNum }); }
            qs.sort(() => Math.random() - 0.5);
            
            // FIX: Set global questions array to the specific table set
            questions = qs;
            
            settings = { count: qs.length, fixedQuestions: qs, durationMinutes: settings.durationMinutes, ops:['multiply'] }; 
            $('table-info-text').textContent = `√ñvar ${tableNum}:ans tabell`;
            runCountdown(() => startGameLogic(true));
        }

        function startGameLogic(useFixed = false) {
            clearInterval(timerInterval); questionHistory = [];
            $('table-info-text').classList.add('hidden');

            if (gameMode === 'practice' && settings.practiceModeType === 'count') {
                 const infoText = $('table-info-text'); infoText.classList.remove('hidden');
                 let desc = "√ñvning: Antal";
                 if (settings.specificTables && settings.specificTables.length > 0) desc += " ‚Ä¢ Tabeller: " + settings.specificTables.join(',');
                 infoText.textContent = desc;
            }
            if (gameMode === 'practice-table-fixed') $('table-info-text').classList.remove('hidden');
            
            currIdx = 0; score = 0; startTime = performance.now();
            $('time-bar-container').classList.add('hidden');
            showView('game-view'); nextQ();
        }

        function startTimerGame(durationSeconds) {
            clearInterval(timerInterval); currIdx = 0; score = 0; questions = []; questionHistory = [];
            showView('game-view');
            
            const infoText = $('table-info-text'); infoText.classList.remove('hidden');
            let label = "Tr√§ning"; if (gameMode === 'practice') label = "√ñvning";
            let tableTxt = (settings.specificTables && settings.specificTables.length === 10 && settings.specificTables.every((v, i) => v === i+1)) ? "1-10" : (settings.specificTables ? settings.specificTables.join(', ') : "Blandat");
            const minTxt = (durationSeconds / 60) + " min";
            infoText.textContent = `${label}: Tid ${minTxt} ‚Ä¢ Tabeller: ${tableTxt}`;
            
            nextQ();
            
            const barCont = $('time-bar-container'); const bar = $('time-bar');
            barCont.classList.remove('hidden'); bar.style.transition = 'none'; bar.style.width = '100%'; void bar.offsetWidth; 
            setTimeout(() => { bar.style.transition = `width ${durationSeconds}s linear`; bar.style.width = '0%'; }, 50);

            let timeLeft = durationSeconds;
            timerInterval = setInterval(() => { timeLeft--; if (timeLeft <= 0) { clearInterval(timerInterval); endGame(); } }, 1000);
        }

        function runCountdown(onComplete) {
            if (!enableCountdown) { showView('game-view'); setTimeout(onComplete, 50); return; }
            const overlay = $('countdown-layer'); const numEl = $('countdown-number');
            showView('game-view'); $('equation-grid').classList.add('opacity-0'); $('input-area').classList.add('opacity-0');
            overlay.classList.remove('hidden'); let count = 3; numEl.textContent = count;
            
            const int = setInterval(() => {
                count--; if (count > 0) numEl.textContent = count;
                else { clearInterval(int); overlay.classList.add('hidden'); $('equation-grid').classList.remove('opacity-0'); $('input-area').classList.remove('opacity-0'); onComplete(); }
            }, 600);
        }
        
        // Only update to ensure all elements are present and functions tied
        $$('.operator-btn').forEach(b=>{b.onclick=()=>{b.classList.toggle('selected');toggleIntervals();}});
        $('play-btn').onclick=startPractice; $('again-btn').onclick=replay; $('toplist-again-btn').onclick=replay;

        document.onkeydown = e => {
            if (e.key === 'Escape') { clearInterval(timerInterval); clearTimeout(answerTimer); if (!$('start-menu-view').classList.contains('hidden')) return; showView('start-menu-view'); return; }
            if (enableQuickRestart && e.key.toLowerCase() === 'r') { 
                if($('record-view').classList.contains('hidden')) { e.preventDefault(); replay(); return; }
            }
            
            if (!$('start-menu-view').classList.contains('hidden') && ['3','5','7','0'].includes(e.key)) { e.preventDefault(); startTableTraining(e.key==='0'?10:parseInt(e.key)); }
            if ((e.key===' '||e.key==='Enter') && (!$('results-view').classList.contains('hidden') || !$('toplist-view').classList.contains('hidden') || !$('table-training-results-view').classList.contains('hidden'))) { e.preventDefault(); replay(); }
            if (!$('record-view').classList.contains('hidden') && e.key === 'Enter') $('save-record-btn').click();
        };

        initTableButtons('specific-tables-selection'); initTableButtons('training-tables-selection');
        initPctSelection();
        showView('start-menu-view'); updateBtn(); toggleIntervals();
        
        // Default settings init
        $('toggle-countdown').checked = true;
        $('toggle-numpad').checked = true;
        $('toggle-restart').checked = false;
        setNextQLevel(0);
        setAnswerDelay(7);
        updateSettings();
    </script>
</body>
</html>
